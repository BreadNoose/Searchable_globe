<!DOCTYPE html>
<html>
<head>
  <title>Project Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100%; background-color: #aad3df; z-index: 1; }
    
    /* WRAPPER for the left-side controls */
    .left-sidebar {
        position: absolute; 
        top: 20px; 
        left: 20px;
        z-index: 9999;
        width: 250px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 95vh;
        overflow-y: auto;
    }

    /* THE CARD STYLE */
    .panel {
        background: white; 
        padding: 15px; 
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    input[type="text"], input[type="number"], select { 
        display: block; margin-bottom: 10px; padding: 8px; width: 100%; 
        box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; 
    }
    
    .search-container { position: relative; margin-bottom: 0; }
    #searchInput { padding-right: 35px; }

    /* Magnifying Glass Icon */
    .search-icon {
        position: absolute; right: 10px; top: 50%; transform: translateY(-60%);
        width: 18px; height: 18px; fill: #888; pointer-events: none;
    }

    /* Suggestions Dropdown */
    .suggestions-list {
        position: absolute; top: 100%; left: 0; width: 100%;
        background: white; border: 1px solid #ccc; border-top: none;
        max-height: 200px; overflow-y: auto; z-index: 1001;
        display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .suggestion-item { 
        padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9em;
        display: flex; justify-content: space-between; align-items: center; 
    }
    .suggestion-item:hover { background-color: #f0f0f0; }

    .dropdown-icon { height: 20px; margin-left: 10px; }

    /* Filter Section Styles */
    .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .filter-item {
        display: flex;
        align-items: center;
        font-size: 0.9em;
        cursor: pointer;
    }
    
    .filter-item input { margin-right: 6px; cursor: pointer; }
    
    .color-dot {
        width: 10px; height: 10px; border-radius: 50%;
        display: inline-block; margin-right: 6px;
        border: 1px solid rgba(0,0,0,0.1);
    }

    /* Text Colors */
    .text-black { color: black; font-weight: bold; }
    .text-grey { color: #888; font-style: italic; }

    /* Buttons */
    button { cursor: pointer; border-radius: 4px; font-weight: bold; border: none; padding: 8px 15px; width: 100%; }
    
    button.add-btn { background: #24b47e; color: white; margin-top: 5px;}
    button.add-btn:hover { background: #1f9b6c; }
    
    button.search-btn { background: #3388ff; color: white; margin-top: 5px;}
    button.search-btn:hover { background: #2266cc; }
    
    button.delete-btn { background: #ff4d4d; color: white; font-size: 0.8em; margin-top: 8px; width: auto; }
    
    h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }
  </style>
</head>
<body>

  <div class="left-sidebar">
    
    <div class="panel">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search (Name or Color)" autocomplete="off" />
            
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>

            <div id="suggestions" class="suggestions-list"></div>
        </div>
        <button class="search-btn" onclick="searchPoints()">Search</button>
    </div>

    <div class="panel">
        <h3>Add New Location</h3>
        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px; font-style: italic;">
          (Click map to auto-fill)
        </div>
        <input type="text" id="placeName" placeholder="Place Name" />
        <input type="number" id="lat" placeholder="Latitude" step="any" />
        <input type="number" id="lng" placeholder="Longitude" step="any" />
        
        <label style="font-size:0.9em; color:#666;">Marker Color:</label>
        <select id="color">
            <option value="blue">Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="violet">Purple</option>
            <option value="black">Black</option>
        </select>
        
        <button class="add-btn" onclick="addPoint()">Add Location</button>
    </div>

    <div class="panel">
        <h3>Filter Visibility</h3>
        <div class="filter-grid">
            <label class="filter-item">
                <input type="checkbox" value="blue" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #2A81CB;"></span> Blue
            </label>
            <label class="filter-item">
                <input type="checkbox" value="red" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #CB2B3E;"></span> Red
            </label>
            <label class="filter-item">
                <input type="checkbox" value="green" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #2AAD27;"></span> Green
            </label>
            <label class="filter-item">
                <input type="checkbox" value="orange" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #CB8427;"></span> Orange
            </label>
            <label class="filter-item">
                <input type="checkbox" value="violet" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #9C2BCB;"></span> Purple
            </label>
            <label class="filter-item">
                <input type="checkbox" value="black" checked onchange="toggleFilter(this)">
                <span class="color-dot" style="background: #3D3D3D;"></span> Black
            </label>
        </div>
    </div>

  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map;
    let markersLayer;
    let debounceTimer;
    
    let currentPlaceData = []; 
    let activeFilters = new Set(['blue', 'red', 'green', 'orange', 'violet', 'black']);

    const API_URL = 'https://searchable-globe.onrender.com/places'; 
    const EXTERNAL_API_URL = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&q=';

    function getIcon(color) {
        return new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    window.onload = async function() {
        const mapBounds = [[-85, -Infinity], [85, Infinity]];
        
        map = L.map('map', {
            worldCopyJump: true, 
            minZoom: 2, 
            maxBounds: mapBounds, 
            maxBoundsViscosity: 0.0,
            zoomControl: false 
        }).setView([20, 0], 2);

        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        map.on('click', function(e) {
            document.getElementById('lat').value = e.latlng.lat.toFixed(6);
            document.getElementById('lng').value = e.latlng.lng.toFixed(6);
        });

        markersLayer = L.layerGroup().addTo(map);
        await loadPoints();

        document.getElementById('searchInput').addEventListener('input', handleTyping);
        document.addEventListener('click', function(e) {
            if (e.target.id !== 'searchInput') {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
    };

    window.toggleFilter = function(checkbox) {
        const color = checkbox.value;
        if (checkbox.checked) {
            activeFilters.add(color);
        } else {
            activeFilters.delete(color);
        }
        renderMarkers();
    }

    function renderMarkers() {
        markersLayer.clearLayers();
        
        currentPlaceData.forEach(place => {
            const markerColor = place.color || 'blue';
            
            if (activeFilters.has(markerColor)) {
                const popupContent = `
                    <div style="text-align:center">
                        <b>${place.name}</b><br>
                        <span style="font-size: 0.85em; color: #555;">
                            (${place.lat.toFixed(4)}, ${place.lng.toFixed(4)})
                        </span><br>
                        <button class="delete-btn" onclick="deletePoint(${place.id})">Delete</button>
                    </div>
                `;
                L.marker([place.lat, place.lng], { icon: getIcon(markerColor) })
                  .addTo(markersLayer)
                  .bindPopup(popupContent);
            }
        });
    }

    async function loadPoints(searchTerm = '') {
      try {
        let url = API_URL;
        if (searchTerm) {
            url += `?search=${encodeURIComponent(searchTerm)}`;
        }

        const response = await fetch(url);
        currentPlaceData = await response.json(); 
        
        renderMarkers();

        if (searchTerm && currentPlaceData.length > 0) {
            const first = currentPlaceData[0];
            if (activeFilters.has(first.color || 'blue')) {
                map.flyTo([first.lat, first.lng], 10);
            }
        }
      } catch (err) {
        console.error("Error fetching from Python:", err);
      }
    }

    function searchPoints() {
        const query = document.getElementById('searchInput').value;
        loadPoints(query);
    }

    function handleTyping() {
        const query = document.getElementById('searchInput').value;
        const suggestionsBox = document.getElementById('suggestions');
        clearTimeout(debounceTimer);

        if (query.length < 3) {
            suggestionsBox.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(async () => {
            try {
                const internalPromise = fetch(`${API_URL}?search=${encodeURIComponent(query)}`).then(res => res.json());
                const externalPromise = fetch(`${EXTERNAL_API_URL}${encodeURIComponent(query)}`).then(res => res.json());

                const [internalData, externalData] = await Promise.all([internalPromise, externalPromise]);

                suggestionsBox.innerHTML = '';
                let hasResults = false;

                if (internalData.length > 0) {
                    hasResults = true;
                    // Limit search results to 5
                    internalData.slice(0, 5).forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item text-black';
                        
                        const lat = parseFloat(place.lat).toFixed(2);
                        const lng = parseFloat(place.lng).toFixed(2);
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = `${place.name} (${lat}, ${lng})`;
                        div.appendChild(textSpan);

                        const iconImg = document.createElement('img');
                        const color = place.color || 'blue';
                        iconImg.src = `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`;
                        iconImg.className = 'dropdown-icon';
                        div.appendChild(iconImg);
                        
                        div.onclick = () => {
                            document.getElementById('searchInput').value = place.name;
                            document.getElementById('placeName').value = place.name;
                            document.getElementById('lat').value = place.lat;
                            document.getElementById('lng').value = place.lng;
                            
                            suggestionsBox.style.display = 'none';
                            
                            const colorFilter = document.querySelector(`input[value="${color}"]`);
                            if (colorFilter && !colorFilter.checked) {
                                colorFilter.checked = true;
                                activeFilters.add(color);
                            }
                            
                            searchPoints(); 
                        };
                        suggestionsBox.appendChild(div);
                    });
                }

                if (externalData.length > 0) {
                    hasResults = true;
                    externalData.slice(0, 5).forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item text-grey';
                        
                        const lat = parseFloat(place.lat).toFixed(2);
                        const lng = parseFloat(place.lon).toFixed(2);
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = `${place.display_name} (${lat}, ${lng})`;
                        div.appendChild(textSpan);
                        
                        div.onclick = () => {
                            const exactLat = parseFloat(place.lat).toFixed(6);
                            const exactLng = parseFloat(place.lon).toFixed(6);
                            
                            document.getElementById('searchInput').value = place.display_name.split(",")[0]; 
                            document.getElementById('placeName').value = place.display_name.split(",")[0]; 
                            document.getElementById('lat').value = exactLat;
                            document.getElementById('lng').value = exactLng;
                            
                            suggestionsBox.style.display = 'none';
                            map.flyTo([exactLat, exactLng], 10);
                        };
                        suggestionsBox.appendChild(div);
                    });
                }

                suggestionsBox.style.display = hasResults ? 'block' : 'none';

            } catch (err) {
                console.error("Autofill error:", err);
            }
        }, 400);
    }

    window.addPoint = async function() {
      const name = document.getElementById('placeName').value;
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      const color = document.getElementById('color').value;

      if (!name || isNaN(lat) || isNaN(lng)) return alert("Please fill all fields");

      const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, lat, lng, color })
      });

      if (response.ok) {
          const colorFilter = document.querySelector(`input[value="${color}"]`);
          if (colorFilter && !colorFilter.checked) {
            colorFilter.checked = true;
            activeFilters.add(color);
          }
          
          document.getElementById('searchInput').value = ''; 
          loadPoints(); 
      } else {
          alert("Error saving location");
      }
    }

    window.deletePoint = async function(id) {
        if (!confirm("Are you sure you want to delete this location?")) return;
        const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (response.ok) loadPoints();
        else alert("Error deleting location");
    }
  </script>
</body>
</html>
